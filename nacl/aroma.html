<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hi</title>
  <style type="text/css">
    embed {
      border: 4px dashed #666;
    }

    textarea {
      width: 400px;
      height: 200px;
    }

    body {
      margin-top: 40px;
      background: #eee;
    }

    .editor, .game, .box {
      vertical-align: top;
      background: white;
      padding: 8px;
      margin: 0px 8px;
      display: inline-block;
      box-shadow: 0px 0px 8px rgba(0,0,0, 0.3);
    }

    .editor .buttons {
      text-align: right;
    }

    .err {
      color: #931A1A;
    }

  </style>
</head>
<body>

  <div class="game">
    <div id="listener">
      <embed name="nacl_module"
        id="aroma"
        width=300 height=300
        src="aroma.nmf"
        type="application/x-nacl" />
    </div>
  </div>

  <div class="editor">
    <textarea id="input"></textarea>
    <div class="buttons">
      <span class="loading">Loading...</span>
      <button id="run">Execute</button>
    </div>
  </div>

  <pre id="output"></pre>

  <script type="text/javascript" src="js/aroma.js"></script>
  <script type="text/javascript">
    (function() {
      $ = function(name) { return document.getElementById(name); }
      A = function(thing) { return Array.prototype.slice.apply(thing) };

      var output = $("output");

      function escape_html(str) {
        return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      game = new Aroma(document.getElementById("listener"), {
        loaded: function() {
          A(document.querySelectorAll(".loading")).map(function(e) {
            e.style.display = "none";
          });
        },
        std_out: function(str) {
          output.innerHTML += escape_html(str) + "\n";
        },
        std_err: function(str) {
          output.innerHTML += "<span class='err'>" +
            escape_html(str) + "</span>\n";
        }
      });

      $("input").value = escape_html([
        "local g = aroma.graphics",
        "",
        "local x, t = 0, 0",
        "",
        "function aroma.update(dt)",
        "  t = t + dt*3",
        "  x = (math.sin(t) - 1)/2",
        "end",
        "",
        "function aroma.draw()",
        "  g.rectangle(x,x,1,1)",
        "end"
      ].join("\n"));

      $("run").onclick = function() {
        var code = $("input").value;
        output.innerHTML = "";
        game.execute(code);
      }
    })();
  </script>
</body>
</html>
